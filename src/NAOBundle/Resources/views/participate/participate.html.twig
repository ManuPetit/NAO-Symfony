{# src/NAOBundle/ressources/views/participate/participate.html.twig #}

{% extends "NAOBundle::layout.html.twig" %}

{% block title %}{{ parent() }} - Participer {% endblock %}

{% block body %}
    <div id="participer-section" class="py-5">
        <div class="container">
            {% for message in app.session.flashbag.get('info') %}
            <div class="row justify-content-center mb-3">
                <div class="col-12 text-center alert-info p-3">
                    <span>{{ message }}</span>
                </div>
            </div>
            {% endfor %}
            <div class="row">
                <div class="col-12 text-center pb-3">
                    <h1>Saisir une observation</h1>
                </div>
            </div>
            <div id="observation_form">
            {{ form_start(form) }}
                {{ form_errors(form) }}
                {{ form_row(form.bird) }}
                <div class="row">
                    <div class="form-group col-12 col-md-6">
                        {{ form_label(form.title, "Titre *", {'label_attr': {'class': 'control-label'}}) }}
                        {{ form_errors(form.title) }}
                        {{ form_widget(form.title, {'attr': {'class': 'form-control'}}) }}
                    </div>
                    <div class="form-group col-12 col-md-6">
                        {{ form_label(form.place, "Lieu *", {'label_attr': {'class': 'control-label'}}) }}
                        {{ form_errors(form.place) }}
                        {{ form_widget(form.place, {'attr': {'class': 'form-control'}}) }}
                    </div>
                </div>
                <div class="row">
                    <div class="form-group col-12 col-md-12">
                        <div class="container" id="map"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group col-12 col-md-6">
                        {{ form_label(form.latitude, "latitude *", {'label_attr': {'class': 'control-label'}}) }}
                        {{ form_errors(form.latitude) }}
                        {{ form_widget(form.latitude, {'attr': {'class': 'form-control'}}) }}
                    </div>
                    <div class="form-group col-12 col-md-6">
                        {{ form_label(form.longitude, "longitude *", {'label_attr': {'class': 'control-label'}}) }}
                        {{ form_errors(form.longitude) }}
                        {{ form_widget(form.longitude, {'attr': {'class': 'form-control'}}) }}
                    </div>
                </div>
                <div class="row">
                    <div class="form-group col-12 col-md-6">
                        {{ form_label(form.date, "Date de l'observation *", {'label_attr': {'class': 'control-label'}}) }}
                        {{ form_errors(form.date) }}
                        {{ form_widget(form.date, {'attr': {'class': 'form-control'}}) }}
                    </div>
                </div>
                <div class="row">
                    <div class="form-group col-12">
                        {{ form_label(form.content, "Description *", {'label_attr': {'class': 'control-label'}}) }}
                        {{ form_errors(form.content) }}
                        {{ form_widget(form.content, {'attr': {'class': 'form-control'}}) }}
                    </div>
                </div>
                        {{ form_row(form.photos) }}
                        <!--<a href="#" id="add_photo" class="btn btn-info">Ajouter une photo</a>-->
                <div class="row justify-content-around">
                    <div class="col-12 col-md-4 py-2">
                        {{ form_widget(form.save, {'attr': {'class': 'btn btn-block'}}) }}
                    </div>
                    <div class="col-12 col-md-4 py-2">
                        {{ form_widget(form.saveAndAdd, {'attr': {'class': 'btn btn-block'}}) }}
                    </div>
                </div>
                {{ form_rest(form) }}
                {{ form_end(form) }}
            </div>
        </div>
    </div>

    {% block javascripts %}
    {{ parent() }}

    <script>
        $(function(){
            //Mise en place du Français pour le datepicker
            $.datepicker.regional['fr'] = {
                closeText: 'Fermer',
                prevText: 'Précédent',
                nextText: 'Suivant',
                currentText: 'Aujourd\'hui',
                monthNames: ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'],
                monthNamesShort: ['Janv.','Févr.','Mars','Avril','Mai','Juin','Juil.','Août','Sept.','Oct.','Nov.','Déc.'],
                dayNames: ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'],
                dayNamesShort: ['Dim.','Lun.','Mar.','Mer.','Jeu.','Ven.','Sam.'],
                dayNamesMin: ['D','L','M','M','J','V','S'],
                weekHeader: 'Sem.',
                dateFormat: 'dd/mm/yy',
                firstDay: 1,
                isRTL: false,
                showMonthAfterYear: false,
                yearSuffix: ''};
            $.datepicker.setDefaults($.datepicker.regional['fr']);
            //Ajout du datepicker
            $("#naobundle_observation_date").datepicker();
        });
    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmofWU0olWbvT_AZBjmqo3IhPjC0gLPf4&callback=initMap">
    </script>
    <script>
        $('#map').hide();
        $('#naobundle_observation_place').click(function(){
            $('#map').show();
            initMap();
        })

       var image = '{{ asset('img/mini-oiseau.png') }}';
       var map;
       var marker;
       var geocoder;
       var toulouse = {lat: 43.600452, lng: 1.427867};
       function initMap() {
            geocoder = new google.maps.Geocoder();
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 6,
                center: toulouse,
                mapTypeId: google.maps.MapTypeId.TERRAIN
            });

            function placeMarker(location) {
                if(marker){
                    marker.setPosition(location);
                } else {
                    marker = new google.maps.Marker({
                        position:location,
                        map:map,
                        icon:image
                    });
                }
                //récupération des coordonnées gps
                console.log(location.lat());
                $('#naobundle_observation_latitude').val(location.lat());
                $('#naobundle_observation_longitude').val(location.lng());

                var latlng = {lat: location.lat(), lng: location.lng()};
                geocoder.geocode({'location': latlng}, function(results,status){
                    if(status === 'OK'){
                        $('#naobundle_observation_place').val(results[1].address_components[0].long_name);
                    } else {
                        $('#naobundle_observation_place').val('Echec de la géolocalisation : ' + status);
                    }
                })
            }
            google.maps.event.addListener(map, 'click', function(event) {
                placeMarker(event.latLng);
            });
       }
    </script>
    <script type="text/javascript">
        $(document).ready(function() {
            var $container = $('div#naobundle_observation_photos');
            var index = $container.find(':input').length;
            $('#add_photo').click(function(e) {
                addPhoto($container);
                e.preventDefault();
                return false;
            });

            if (index == 0) {addPhoto($container);}
            function addPhoto($container) {
                var template = $container.attr('data-prototype')
                    .replace(/__name__label__/g, 'Photo n°' + (index+1))
                    .replace(/__name__/g,        index)
                ;
                var $prototype = $(template);
                addDeleteLink($prototype);
                $container.append($prototype);
                index++;
            }
            function addDeleteLink($prototype) {
                var $deleteLink = $('<a href="#" class="btn btn-danger">Supprimer</a>');
                $prototype.append($deleteLink);
                $deleteLink.click(function(e) {
                    $prototype.remove();
                    e.preventDefault();
                    return false;
                });
            }
        });
    </script>
    {% endblock %}

{% endblock %}